---
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import "../global-styles.astro";

interface Props {
	title: string;
}

const { title } = Astro.props;
---

<script>
	const themeToggleBtn = document.getElementById("theme-toggle");
	const rootElement = document.documentElement;
	const themes = ["light", "dark"] as const;
	type Theme = (typeof themes)[number];
	let themeIndex = 0;
	let hoverLocked = false;

	const getCurrentTheme = (): Theme => {
		if (rootElement.classList.contains("dark")) {
			return "dark";
		}
		return "light";
	};

	const applyTheme = (theme: Theme) => {
		rootElement.classList.remove("dark");
		if (theme === "dark") {
			rootElement.classList.add("dark");
		}
		rootElement.setAttribute("data-theme", theme);
		localStorage.setItem("theme", theme);
		const index = themes.indexOf(theme);
		themeIndex = index === -1 ? 0 : index;
		if (themeToggleBtn) {
			themeToggleBtn.dataset.theme = theme;
		}
	};

	const isTheme = (value: string): value is Theme =>
		themes.includes(value as Theme);

	const initializeTheme = (): Theme => {
		const currentTheme = getCurrentTheme();
		const storedTheme = localStorage.getItem("theme");
		if (storedTheme && isTheme(storedTheme)) {
			applyTheme(storedTheme);
			return storedTheme;
		}
		applyTheme(currentTheme);
		return currentTheme;
	};

	document.addEventListener("DOMContentLoaded", () => {
		const initialTheme = initializeTheme();
		if (themeToggleBtn) {
			themeToggleBtn.dataset.theme = initialTheme;
			themeToggleBtn.addEventListener("click", () => {
				const nextTheme = themes[(themeIndex + 1) % themes.length];
				applyTheme(nextTheme);
				hoverLocked = true;
				themeToggleBtn.dataset.hoverLocked = "true";
			});
			const releaseHoverLock = () => {
				if (!hoverLocked) {
					return;
				}
				hoverLocked = false;
				delete themeToggleBtn.dataset.hoverLocked;
			};
			themeToggleBtn.addEventListener("mouseleave", releaseHoverLock);
			themeToggleBtn.addEventListener("blur", releaseHoverLock);
		}
	});
</script>

<html lang="en">
	<head>
		<script is:inline>
			(function () {
				var savedTheme = localStorage.getItem("theme");

				function applyTheme(theme) {
					document.documentElement.classList.remove("dark");
					if (theme === "dark") {
						document.documentElement.classList.add("dark");
					}
					document.documentElement.setAttribute("data-theme", theme);
				}

				function checkSystemThemePreferences() {
					var prefersDark = window.matchMedia(
						"(prefers-color-scheme: dark)",
					).matches;
					if (prefersDark) {
						applyTheme("dark");
					}
				}

				if (savedTheme) {
					applyTheme(savedTheme);
				} else {
					checkSystemThemePreferences();
				}
			})();
		</script>
		<meta charset="UTF-8" />
		<meta name="description" content="Astro description" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/x-icon" href="/images/rabbit-16.ico" />
		<meta name="generator" content={Astro.generator} />
		
		<link rel="dns-prefetch" href="https://github.com" />
		<link rel="dns-prefetch" href="https://api.github.com" />
		<link rel="preconnect" href="https://github.com" />
		
		<link rel="preload" href="/fonts/vt323-regular.ttf" as="font" type="font/ttf" crossorigin />
		<link rel="preload" href="/fonts/atkinson-hyperlegible-regular.ttf" as="font" type="font/ttf" crossorigin />
		
		<title>{title}</title>
	</head>
	<body class=`min-h-screen dark:bg-[var(--color-bg-dark)] dark:text-white`>
		<div
			id="main-wrapper"
			class="max-w-3xl mx-auto px-4 flex flex-col min-h-screen sm:w-full"
		>
			<Navbar />
			<slot />
			<Footer />
		</div>
	</body>

	<style is:global>
		:root {
			/* Fonts */
			--font-mono: "IBM Plex Mono", monospace;
			--font-merriweather: "Merriweather", serif;
			--font-atkinson: "Atkinson Hyperlegible", sans-serif;
			--font-vt323: "VT323", monospace;
			
			/* Colors - Light mode */
			--color-bg-light: #fafafa;
			--color-bg: #fafafa;
			--color-bg-dark: #1a1a1a;
			--color-text: #000000;
			--color-text-muted: #6b6b6b;
			--color-link: #0000ee;
			--color-link-hover: #ff0000;
			--color-link-visited: #551a8b;
			--color-logo-dark: #aae574;
			--color-logo-dark-hover: #d7f48c;
			--color-highlight-dark: var(--color-logo-dark);
			--color-border: #0000ee;
			
			/* Accents */
			--accent: 136, 58, 234;
			--accent-light: 224, 204, 250;
			--accent-dark: 49, 10, 101;
			--accent-gradient: linear-gradient(
				45deg,
				rgb(var(--accent)),
				rgb(var(--accent-light)) 30%,
				white 60%
			);
		}
		
	html.dark {
		--color-bg: var(--color-bg-dark);
		--color-text: #e5e5e5;
		--color-text-muted: #d1d5db;
		--color-link-visited-dark: #a855f7;
		--color-text-dark: #e5e5e5;
		--color-text-h2: #ffffff;
		--color-text-h3: #e5e5e5;
		--color-text-h4: #d4d4d4;
		--color-text-h5: #cccccc;
		--color-text-h6: #b3b3b3;
	}
		
		html {
			font-family: system-ui, sans-serif;
			background: var(--color-bg);
		}
		
		code {
			font-family: var(--font-mono) !important;
		}

		html.dark :not(pre) > code {
			background-color: rgba(170, 229, 116, 0.15);
			color: var(--color-highlight-dark);
			border: 1px solid var(--color-highlight-dark);
			border-radius: 0.1rem;
			padding: 0 0.15rem;
		}

		html,
		body {
			overflow-x: hidden;
		}
		
		a[href],
		button {
			cursor: pointer;
		}

		.prose
			:where(pre):not(
				:where([class~="not-prose"], [class~="not-prose"] *)
			) {
			border-radius: 0rem !important;
		}

		.prose :where(blockquote) {
			color: var(--color-text);
		}

		.dark .astro-code {
			background-color: var(--shiki-dark-bg) !important;
		}

		html:not(.dark) a {
			color: var(--color-link);
		}

		html:not(.dark) a:hover {
			color: var(--color-link-hover);
		}

		html:not(.dark) a:visited {
			color: var(--color-link-visited);
		}

		html:not(.dark) nav #logo,
		html:not(.dark) nav #logo:visited {
			color: var(--color-link);
		}

		html:not(.dark) nav #logo:hover,
		html:not(.dark) nav #logo:focus-visible {
			color: #ffff11;
			outline: none;
		}

		html.dark nav #logo,
		html.dark nav #logo:visited {
			color: var(--color-logo-dark);
		}

		html.dark nav #logo:hover,
		html.dark nav #logo:focus-visible {
			color: #a855f7;
			outline: none;
		}

		html:not(.dark) nav #right-navbar a,
		html:not(.dark) nav #right-navbar a:visited {
			color: inherit;
		}

		html:not(.dark) footer a:visited {
			color: var(--color-link);
		}

		html.dark a {
			color: var(--color-link-visited-dark);
		}

	html.dark a:hover {
		color: #e5e5e5;
	}

	html.dark a:visited {
		color: var(--color-link-visited-dark);
	}

	html.dark nav #right-navbar a,
	html.dark nav #right-navbar a:visited,
	html.dark footer a:visited {
		color: inherit;
	}

	html.dark b,
	html.dark strong {
		color: var(--color-text-dark);
	}

		html.dark nav #right-navbar a:hover {
			color: #ffffff;
		}

		article.prose :where(h2, h3, h4, h5, h6) {
			font-family: var(--font-merriweather) !important;
			margin-top: 1rem !important;
			margin-bottom: 0.5rem !important;
			line-height: 1.3;
		}

		article.prose h2 {
			font-size: 26px !important;
		}

		article.prose h3 {
			font-size: 20px !important;
		}

		article.prose h4 {
			font-size: 18px !important;
		}

		article.prose h5 {
			font-size: 16px !important;
		}

		article.prose h6 {
			font-size: 14px !important;
		}

		article.prose h2 {
			font-size: 26px !important;
			color: var(--color-text-h2);
		}

		article.prose h3 {
			font-size: 20px !important;
			color: var(--color-text-h3);
		}

		article.prose h3 {
			font-size: 20px !important;
			color: var(--color-text-h3);
		}

		article.prose h4 {
			font-size: 18px !important;
			color: var(--color-text-h4);
		}

		article.prose h5 {
			font-size: 16px !important;
			color: var(--color-text-h5);
		}

		article.prose h6 {
			font-size: 14px !important;
			color: var(--color-text-h6);
		}

	article.prose h2 {
			font-size: 26px !important;
		}

	article.prose h3 {
			font-size: 20px !important;
		}

	article.prose h4 {
			font-size: 18px !important;
		}

	article.prose h5 {
			font-size: 16px !important;
		}

	article.prose h6 {
			font-size: 14px !important;
		}

		#theme-toggle {
			color: #9ca3af;
			position: relative;
		}

		#theme-toggle svg {
			display: block;
			width: 22px;
			height: 22px;
		}

		#theme-toggle .theme-icon {
			color: inherit;
		}

		#theme-toggle[data-theme="light"] .theme-icon-light {
			color: var(--color-link);
		}

		#theme-toggle[data-theme="light"] .theme-icon-dark {
			color: #9ca3af;
		}

		#theme-toggle[data-theme="light"]:not([data-hover-locked="true"]):hover
			.theme-icon-light {
			color: #d1d5db;
		}

		#theme-toggle[data-theme="light"]:not([data-hover-locked="true"]):hover
			.theme-icon-dark {
			color: var(--color-link);
		}

		#theme-toggle[data-theme="dark"] .theme-icon-dark {
			color: #ffffff;
		}

		#theme-toggle[data-theme="dark"] .theme-icon-light {
			color: #4b5563;
		}

		#theme-toggle[data-theme="dark"]:not([data-hover-locked="true"]):hover
			.theme-icon-dark {
			color: #4b5563;
		}

		#theme-toggle[data-theme="dark"]:not([data-hover-locked="true"]):hover
			.theme-icon-light {
			color: #ffffff;
		}

		.astro-code {
			font-size: 14px !important;
			border: none !important;
			padding: 1.2rem !important;
			background-color: rgba(0, 0, 0, 0.05) !important;
			border-left: 3px solid var(--color-link) !important;
		}

		html.dark .astro-code {
			background-color: rgba(255, 255, 255, 0.05) !important;
			border-left: 3px solid var(--color-highlight-dark) !important;
		}

		.dark .astro-code,
		.dark .astro-code span {
			color: var(--shiki-dark) !important;
			font-style: var(--shiki-dark-font-style) !important;
			font-weight: var(--shiki-dark-font-weight) !important;
			text-decoration: var(--shiki-dark-text-decoration) !important;
		}

		.copy-code {
			position: absolute;
				top: -0.35rem;
			right: 0;
			padding: 0.05rem 0.5rem;
			cursor: pointer;
			font-size: 12px;
			font-family: var(--font-atkinson);
			text-transform: lowercase;
			background: #ffffff;
			border: 2px solid #c0c0c0;
			color: #000000;
		}

	html.dark .copy-code {
		color: #ffffff;
		background: #3d3d3d;
		border-color: #6b6b6b;
	}

		html:not(.dark) .copy-code:hover,
		html:not(.dark) .copy-code:focus-visible {
			border-color: #808080;
			color: #1a1a1a;
			outline: none;
		}

		html.dark .copy-code:hover,
		html.dark .copy-code:focus-visible {
			border-color: #a0a0a0;
			color: #e5e5e5;
		}

		html:not(.dark) .copy-code.copied {
			animation: blink-light 0.5s steps(1, end);
		}

		html.dark .copy-code.copied {
			animation: blink-dark 0.5s steps(1, end);
		}

		@keyframes blink-light {
			0%, 100% { border-color: #c0c0c0; }
			12.5% { border-color: var(--color-link); }
			25% { border-color: #c0c0c0; }
			37.5% { border-color: var(--color-link); }
			50% { border-color: #c0c0c0; }
		}

		@keyframes blink-dark {
			0%, 100% { border-color: #6b6b6b; }
			12.5% { border-color: var(--color-logo-dark); }
			25% { border-color: #6b6b6b; }
			37.5% { border-color: var(--color-logo-dark); }
			50% { border-color: #6b6b6b; }
		}

	.mermaid {
		font-family: var(--font-mono) !important;
		background: transparent !important;
	}

	.mermaid svg {
		background: transparent !important;
	}

	.mermaid .edgeLabel,
	.mermaid .labelBkg {
		background-color: var(--color-bg-light) !important;
	}

	.dark .mermaid .node rect,
	.dark .mermaid .node circle,
	.dark .mermaid .node ellipse,
	.dark .mermaid .node polygon,
	.dark .mermaid .node path {
		fill: transparent !important;
		stroke: #ffffff !important;
	}

	.dark .mermaid .edgePath .path {
		stroke: #ffffff !important;
	}

	.dark .mermaid .edgePath marker path {
		fill: #ffffff !important;
		stroke: #ffffff !important;
	}

	.dark .mermaid marker path {
		fill: #ffffff !important;
		stroke: #ffffff !important;
	}

	.dark .mermaid .flowchart-link {
		stroke: #ffffff !important;
	}

	.dark .mermaid .edgeLabel,
	.dark .mermaid .labelBkg {
		background-color: var(--color-bg-dark) !important;
		color: #ffffff !important;
	}

	.dark .mermaid .label {
		color: #ffffff !important;
	}

	.dark .mermaid .nodeLabel,
	.dark .mermaid .edgeLabel {
		color: #ffffff !important;
	}

	.dark .mermaid .cluster rect {
		fill: transparent !important;
		stroke: #ffffff !important;
	}

	.dark .mermaid .edgeLabel .label {
		background-color: var(--color-bg-dark) !important;
	}
	</style>
</html>
