---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../utils/dates";
import type { Post } from "../../types";
import { calculateReadingTime } from "../../utils/misc";
import Comments from "../../components/Comments.vue";

interface Props {
	post: CollectionEntry<"posts">;
}

export async function getStaticPaths() {
	const blogPosts = await getCollection("posts");
	return blogPosts.map((post: Post) => ({
		params: { slug: post.id },
		props: { post },
	}));
}

const { post } = Astro.props;
const { Content } = await post.render();
const hasImage = post.data.cover;
const isDraft = post.data.draft;
const readingTime = calculateReadingTime(post.body || "");

const date = new Date(post.data.date);
const formattedDate = formatDate(date);
---

<script>
	const copyButtonLabel = "Copy";
	const copyButtonActiveLabel = "Done";

	document.querySelectorAll("pre").forEach((codeBlock) => {
		if (!codeBlock.classList.contains("mermaid")) {
			addCopyButton(codeBlock);
		}
	});

	function addCopyButton(codeBlock: HTMLElement) {
		const wrapper = document.createElement("div");
		wrapper.style.position = "relative";

		const copyButton = document.createElement("button");
		copyButton.className = "copy-code";
		copyButton.textContent = copyButtonLabel;

		codeBlock.setAttribute("tabindex", "0");

		codeBlock.parentNode?.insertBefore(wrapper, codeBlock);
		wrapper.appendChild(codeBlock);
		wrapper.appendChild(copyButton);

		copyButton.addEventListener("click", () =>
			handleCopy(codeBlock, copyButton),
		);
	}

	async function handleCopy(
		codeBlock: HTMLElement,
		button: HTMLButtonElement,
	) {
		const codeElement = codeBlock.querySelector("code");
		if (!codeElement) return;

		// Copy text content to clipboard
		await navigator.clipboard.writeText(codeElement.innerText);

		// Add copied class for animation
		button.classList.add("copied");

		setTimeout(() => {
			button.classList.remove("copied");
		}, 500);
	}
</script>

<Layout title={post.data.title}>
	<div class="flex flex-col items-center justify-center min-h-screen mt-8">
		<article class="prose dark:prose-invert prose-stone w-full max-w-3xl">
			{
				hasImage && post.data.cover && (
					<Image
						class="object-cover object-center !m-0 aspect-square block"
						src={post.data.cover}
						alt={post.data.title}
						width={600}
						height={600}
					/>
				)
			}
			<h1 id="title">
				{post.data.title}
			</h1>
			<div class="flex items-center gap-3">
				<a id="post-date">
					{formattedDate} -
					<span id="reading-time" class="ml-1">
						{readingTime} m read
					</span>
				</a>
				<div class="flex gap-2">
					{post.data.tags.map(tag => (
						<a href={`/?tag=${tag}`} class="post-tag">{tag}</a>
					))}
				</div>
			</div>
			{
				isDraft && (
					<div
						class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 pl-2 my-4 dark:bg-yellow-900 dark:border-yellow-500 dark:text-yellow-200"
						role="alert"
					>
						<p class="font-bold">Note:</p>
						<p>This post is still in progress.</p>
					</div>
				)
			}
			<div id="post-content">
				<Content />
			</div>
		</article>
		<Comments client:load title={post.data.title} />
	</div>
</Layout>

<style>
	#title {
		font-family: var(--font-merriweather);
		font-size: 32px;
		margin-bottom: 4px;
		line-height: 1.2;
		text-align: left;
		hyphens: none;
		text-wrap: wrap;
		display: block;
		width: 100%;
		word-break: normal;
		overflow-wrap: normal;
		color: var(--color-text);
	}

	#post-date {
		font-family: var(--font-atkinson);
		font-size: 14px;
		font-weight: 400;
		color: var(--color-text-muted);
		text-decoration: none;
	}

	.prose {
		font-family: var(--font-atkinson);
		font-size: 17px;
		max-width: none;
		overflow-wrap: break-word;
		line-height: 1.6;
		text-align: left;
		hyphens: auto;
		text-wrap: balance;
		margin: 0 auto;
	}

	.prose h2 {
		font-family: var(--font-merriweather);
		font-size: 24px;
		margin-top: 2rem;
		margin-bottom: 1rem;
		line-height: 1.3;
	}

	.prose h3 {
		font-family: var(--font-merriweather);
		font-size: 20px;
		margin-top: 1.5rem;
		margin-bottom: 0.75rem;
		line-height: 1.3;
	}

	.prose h4 {
		font-family: var(--font-merriweather);
		font-size: 18px;
		margin-top: 1.25rem;
		margin-bottom: 0.5rem;
		line-height: 1.3;
	}

	.prose p {
		margin-bottom: 1.25rem;
	}

	.prose ul, .prose ol {
		margin-bottom: 1.25rem;
	}

	.prose code {
		font-family: var(--font-mono);
	}

	.prose pre code {
		font-family: var(--font-mono);
	}

	:global(.prose pre) {
	  position: relative;
	  padding-top: 2rem;
	}

	@media (max-width: 640px) {
		.prose {
			text-align: left;
		}
	}

	:global(.copy-code) {
	  position: absolute;
	  top: -0.35rem;
	  right: 0.5rem;
	  z-index: 10;
	}

	.post-tag {
		font-family: var(--font-atkinson);
		font-size: 12px;
		padding: 0.05rem 0.5rem;
		border: 1px solid #c0c0c0;
		color: #000000;
		text-transform: lowercase;
		text-decoration: none;
		cursor: pointer;
		background: #ffffff;
	}

	.post-tag:hover,
	.post-tag:focus-visible,
	.post-tag:visited:hover,
	.post-tag:visited:focus-visible {
		background-color: #f0f0f0;
		color: #000000;
		border-color: #b8b8b8;
		outline: none;
	}

	.post-tag:active {
		background-color: #e5e5e5;
		border-color: #afafaf;
		color: var(--color-link);
	}

	.post-tag:visited {
		color: #000000;
	}

	:global(html.dark) .post-tag {
		color: #ffffff;
		background: #2c2c2c;
		border: 1px solid transparent;
	}

	:global(html.dark) .post-tag:hover,
	:global(html.dark) .post-tag:focus-visible,
	:global(html.dark) .post-tag:visited:hover,
	:global(html.dark) .post-tag:visited:focus-visible {
		background-color: #242424;
		color: #ffffff;
		border-color: #ffffff;
	}

	:global(html.dark) .post-tag:active {
		background-color: #1e1e1e;
		border-color: #d1d5db;
		color: var(--color-highlight-dark);
	}

	:global(html.dark) .post-tag:visited {
		color: #ffffff;
	}

</style>
