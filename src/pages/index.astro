---
import { getCollection } from "astro:content";
import { SITE_CONFIG } from "../config";
import Layout from "../layouts/Layout.astro";
import type { Post } from "../types";
import { formatDate } from "../utils/dates";
import { calculateReadingTime } from "../utils/misc";

const allPosts = await getCollection("posts");
const publishedPosts = allPosts.filter((post: Post) => !post.data.draft);
const allTags = [
	...new Set(publishedPosts.flatMap((post) => post.data.tags)),
].sort();
---

<Layout title={SITE_CONFIG.title}>
  <main class="mt-4 px-3 max-w-85ch sm:mt-8" data-layout="wide">
    <section class="filter-container mb-4" aria-label="Filter posts">
      <div id="tag-filter" class="tag-filter-hidden" role="group" aria-label="Filter by tag">
        {allTags.map(tag => (
          <button class="tag-btn" data-tag={tag} type="button">{tag}</button>
        ))}
      </div>
      <button id="filter-toggle" class="filter-toggle-btn" type="button" aria-expanded="false" aria-controls="tag-filter">filters</button>
    </section>

    <section class="posts-list" aria-label="Blog posts">
      {
        allPosts
          .filter((post: Post) => !post.data.draft)
          .map((post: Post) => {
            const href = "/blog/" + post.id;
            const date = new Date(post.data.date);
            const formattedDate = formatDate(date);
            const readingTime = calculateReadingTime(post.body || "");
            const excerpt = post.data.excerpt;
            const dateIso = post.data.date.toISOString();

            return (
              <article class="flex flex-col mb-6 sm:mb-12 post-item" data-tags={post.data.tags.join(',')}>
                <h2 class="post-title">
                  <a
                    href={href}
                  >
                    {post.data.title}
                  </a>
                </h2>
                <div class="post-meta flex items-center gap-3 mt-1">
                  <time datetime={dateIso} class="post-date">
                    {formattedDate}
                  </time>
                  <span class="post-reading-time">
                    {readingTime} min read
                  </span>
                  <div class="flex gap-2 post-tags-container" role="list">
                    {post.data.tags.map(tag => (
                      <a href={`/?tag=${tag}`} class="post-tag" role="listitem">{tag}</a>
                    ))}
                  </div>
                </div>
                {excerpt && (
                  <p id="post-preview" class="mt-4">
                    {excerpt}
                  </p>
                )}
              </article>
            );
          })
      }
    </section>
  </main>
</Layout>

<style>
  .post-title a {
    font-family: var(--font-merriweather);
    font-size: 22px;
    line-height: 1.3;
    color: var(--color-text);
    text-decoration: none;
  }

  .post-title a:hover {
    text-decoration: underline;
  }

  :global(html:not(.dark)) .post-title a,
  :global(html:not(.dark)) .post-title a:visited {
    color: #000000;
  }

  :global(html.dark) .post-title a,
  :global(html.dark) .post-title a:visited {
    color: #ffffff;
  }

  :global(html:not(.dark)) .post-title a:hover {
    color: #424949;
  }

  :global(html.dark) .post-title a:hover {
    color: #d1d5db;
  }

  @media (min-width: 640px) {
    .post-title a {
      font-size: 24px;
    }
  }

  .post-date,
  .post-reading-time {
    font-family: var(--font-atkinson);
    font-size: 14px;
    font-weight: 400;
    color: var(--color-text-muted);
  }

  #post-preview {
    font-family: var(--font-atkinson);
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
    overflow-wrap: break-word;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: justify;
    hyphens: auto;
    text-wrap: pretty;
  }

  nav #right-navbar a {
    font-family: var(--font-atkinson);
    font-size: 24px;
    font-weight: regular;
  }

  #post-title {
    font-family: var(--font-merriweather);
    font-size: 22px;
    line-height: 1.3;
    color: var(--color-text);
  }

  :global(html:not(.dark) #post-title) {
    color: #000000;
  }

  :global(html:not(.dark) #post-title:visited) {
    color: #000000;
  }

  :global(html.dark #post-title) {
    color: #ffffff;
  }

  :global(html.dark #post-title:visited) {
    color: #ffffff;
  }

  @media (min-width: 640px) {
    #post-title {
      font-size: 24px;
    }
  }

  #post-date {
    font-family: var(--font-atkinson);
    font-size: 14px;
    font-weight: 400;
    color: var(--color-text-muted);
  }

  #post-preview {
    font-family: var(--font-atkinson);
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
    overflow-wrap: break-word;
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-align: justify;
    hyphens: auto;
    text-wrap: pretty;
  }

  #post-preview :global(code) {
    font-family: var(--font-mono);
  }

  #post-preview :global(pre code) {
    font-family: var(--font-mono);
  }

  @media (min-width: 640px) {
    #post-preview {
      -webkit-line-clamp: 4;
    }
  }

  .filter-container {
    display: flex;
    justify-content: flex-end;
    align-items: flex-start;
    position: relative;
    min-height: 2rem;
  }

  #tag-filter {
    position: absolute;
    right: calc(3.2rem + 0.5rem);
    top: 0;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    max-width: calc(100% - 3.7rem);
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .tag-filter-hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .tag-btn {
    font-family: var(--font-atkinson);
    font-size: 14px;
    padding: 0.05rem 0.6rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    border: 1px solid #c0c0c0;
    background: #ffffff;
    cursor: pointer;
    text-transform: lowercase;
    line-height: 1.4;
    color: #000000;
    transition: none;
  }

  :global(html:not(.dark)) .tag-btn:hover {
    background-color: #f0f0f0;
    color: #000000;
    border-color: var(--color-border);
  }

  :global(html:not(.dark)) .tag-btn.active {
    background-color: #e6e6e6;
    color: #000000;
    border-color: var(--color-border);
  }

  :global(html:not(.dark)) .tag-btn:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 1px;
  }

  :global(html.dark) .tag-btn {
    border-color: #ffffff;
    color: #ffffff;
    background: transparent;
    transition: none;
  }

  :global(html.dark) .tag-btn:hover,
  :global(html.dark) .tag-btn.active {
    background-color: #ffffff;
    color: #1a1a1a;
  }

  .post-tag {
    font-family: var(--font-atkinson);
    font-size: 12px;
    padding: 0.05rem 0.5rem;
    border: 1px solid #c0c0c0;
    color: #000000;
    text-transform: lowercase;
    text-decoration: none;
    cursor: pointer;
    background: #ffffff;
  }

  .post-tag:hover,
  .post-tag:focus-visible,
  .post-tag:visited:hover,
  .post-tag:visited:focus-visible {
    background-color: #f0f0f0;
    color: #000000;
    border-color: #b8b8b8;
    outline: none;
  }

  .post-tag:active {
    background-color: #e5e5e5;
    border-color: #afafaf;
    color: var(--color-link);
  }

  .post-tag:visited {
    color: #000000;
  }

  :global(html.dark) .post-tag {
    color: #ffffff;
    background: #2c2c2c;
    border: 1px solid transparent;
  }

  :global(html.dark) .post-tag:hover,
  :global(html.dark) .post-tag:focus-visible,
  :global(html.dark) .post-tag:visited:hover,
  :global(html.dark) .post-tag:visited:focus-visible {
    background-color: #242424;
    color: #ffffff;
    border-color: #ffffff;
  }

  :global(html.dark) .post-tag:active {
    background-color: #1e1e1e;
    border-color: #d1d5db;
    color: var(--color-highlight-dark);
  }

  :global(html.dark) .post-tag:visited {
    color: #ffffff;
  }

  .post-item {
    transition: opacity 0.3s ease;
  }

  .post-item.hidden {
    display: none;
  }

  .filter-toggle-btn {
    font-family: var(--font-atkinson);
    font-size: 14px;
    padding: 0.05rem 0.6rem;
    border: 1px solid var(--color-border);
    background: transparent;
    cursor: pointer;
    text-transform: lowercase;
    line-height: 1.4;
    transition: none;
  }

  :global(html:not(.dark)) .filter-toggle-btn {
    color: #000000;
    border-color: #c0c0c0;
    background-color: #ffffff;
  }

  :global(html:not(.dark)) .filter-toggle-btn:hover {
    background-color: #f0f0f0;
    color: #000000;
    border-color: var(--color-border);
  }

  :global(html:not(.dark)) .filter-toggle-btn:focus-visible {
    outline: 2px solid #000000;
    outline-offset: 1px;
  }

  :global(html:not(.dark)) .filter-toggle-btn.active {
    background-color: transparent;
    color: #6b6b6b;
    border-color: #c0c0c0;
  }

  :global(html.dark) .filter-toggle-btn {
    border-color: #ffffff;
    color: #ffffff;
  }

  :global(html.dark) .filter-toggle-btn:hover {
    background-color: #ffffff;
    color: #1a1a1a;
  }

  :global(html.dark) .filter-toggle-btn:focus-visible {
    outline: 2px solid #ffffff;
    outline-offset: 1px;
  }

  :global(html.dark) .filter-toggle-btn.active {
    background-color: transparent;
    color: #d1d5db;
    border-color: #d1d5db;
  }

  @media (max-width: 600px) {
    #post-preview {
      text-align: left;
    }
  }

  #main-wrapper {
    max-width: 85ch;
  }
</style>

<script>
  const filterToggle = document.getElementById('filter-toggle');
  const tagFilter = document.getElementById('tag-filter');
  const tagButtons = document.querySelectorAll('.tag-btn');
  const postItems = document.querySelectorAll('.post-item');

  filterToggle?.addEventListener('click', () => {
    const isHidden = tagFilter?.classList.contains('tag-filter-hidden');
    tagFilter?.classList.toggle('tag-filter-hidden');
    filterToggle.classList.toggle('active');
    filterToggle.setAttribute('aria-expanded', String(!isHidden));
  });

  const filterPosts = () => {
    const activeTags = Array.from(tagButtons)
      .filter(btn => btn.classList.contains('active'))
      .map(btn => btn.getAttribute('data-tag'))
      .filter((tag): tag is string => tag !== null);

    postItems.forEach(post => {
      const postTags = post.getAttribute('data-tags')?.split(',') || [];

      if (activeTags.length === 0 || activeTags.some(tag => postTags.includes(tag))) {
        post.classList.remove('hidden');
      } else {
        post.classList.add('hidden');
      }
    });
  };

  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      filterPosts();
      updateURL();
    });
  });

  const updateURL = () => {
    const activeTags = Array.from(tagButtons)
      .filter(btn => btn.classList.contains('active'))
      .map(btn => btn.getAttribute('data-tag'))
      .filter((tag): tag is string => tag !== null);

    const url = new URL(window.location.href);
    url.searchParams.delete('tag');

    if (activeTags.length > 0) {
      activeTags.forEach(tag => url.searchParams.append('tag', tag));
    }

    window.history.replaceState({}, '', url.toString());
  };

  const initializeFiltersFromURL = () => {
    const url = new URL(window.location.href);
    const tagParams = url.searchParams.getAll('tag');

    if (tagParams.length > 0) {
      tagFilter?.classList.remove('tag-filter-hidden');
      filterToggle?.classList.add('active');
      filterToggle?.setAttribute('aria-expanded', 'true');

      tagButtons.forEach(btn => {
        const tag = btn.getAttribute('data-tag');
        if (tag && tagParams.includes(tag)) {
          btn.classList.add('active');
        }
      });

      filterPosts();
    }
  };

  initializeFiltersFromURL();
</script>
