---
import Layout from "../layouts/Layout.astro";
import LangColorBar from "../components/LangColorBar.astro";
import { getMultipleRepos, type Language } from "../utils/github";
import { normalizeCase } from "../utils/misc";
import { SITE_CONFIG } from "../config";

type Project = {
	name: string;
	description: string;
	url: string;
	languages: Language[];
};

const fetchProjects = async () => {
	try {
		// Fetch all repos in a single GraphQL query
		const reposMap = await getMultipleRepos(
			SITE_CONFIG.github.username,
			SITE_CONFIG.projects,
		);

		// Transform to project array, maintaining order
		const projects = SITE_CONFIG.projects
			.map((projectName) => {
				const repoData = reposMap.get(projectName);
				if (!repoData) return null;

				const { info: data, languages } = repoData;
				const shouldNormalize = data.name && !data.name.includes(".com");
				const name = shouldNormalize ? normalizeCase(data.name) : data.name;

				return {
					name: name.toLowerCase(),
					description: data.description,
					url: data.html_url,
					languages,
				};
			})
			.filter((p): p is Project => p !== null);

		return projects;
	} catch (error) {
		console.error("Error fetching projects:", error);
		return [];
	}
};

const projects: Project[] = await fetchProjects();
---

<Layout title="Projects">
  <main class="mt-4 px-3 max-w-65ch sm:mt-0">
  {
    projects.length > 0 ? (
      projects.map((project) => (
      <article class="flex flex-col mt-4 mb-6 sm:mt-8 sm:mb-12">
          <h2 class="project-title">
            <a
              href={project.url}
              target="_blank"
              rel="noopener noreferrer"
            >
              {project.name}
            </a>
          </h2>
          <div class="project-languages md:w-96 mt-1 mb-2">
            <LangColorBar
              languages={project.languages}
              projectUrl={project.url}
            />
          </div>
          <p class="project-description">{project.description}</p>
        </article>
      ))
    ) : (
      <p>No projects available or failed to load.</p>
    )
  }
  </main>
</Layout>

<style>
  .page-title {
    font-family: var(--font-merriweather);
    font-size: 32px;
    margin-bottom: 1rem;
    line-height: 1.2;
  }

  .project-title a {
    font-family: var(--font-atkinson);
    font-size: 22px;
    text-decoration: none;
    line-height: 1.3;
    color: var(--color-text);
  }

  .project-title a:visited {
    color: var(--color-text);
  }

  .project-title a:hover,
  .project-title a:focus-visible {
    color: #424949;
  }

  :global(html.dark) .project-title a {
    color: #d1d5db;
  }

  :global(html.dark) .project-title a:visited {
    color: #d1d5db;
  }

  :global(html.dark) .project-title a:hover,
  :global(html.dark) .project-title a:focus-visible {
    color: #ffffff;
  }

  .project-description {
    font-family: var(--font-atkinson);
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
    line-height: 1.6;
    text-align: justify;
    hyphens: auto;
    text-wrap: pretty;
    max-width: 65ch;
  }

  .project-description a {
    color: inherit;
    text-decoration: underline;
  }

  .project-description a:hover,
  .project-description a:focus-visible {
    color: #424949;
  }

  :global(html.dark) .project-description a {
    color: #d1d5db;
  }

  :global(html.dark) .project-description a:hover,
  :global(html.dark) .project-description a:focus-visible {
    color: #a855f7;
  }

  @media (max-width: 600px) {
    .project-description {
      text-align: left;
    }
  }
</style>
