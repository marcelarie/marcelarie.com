---
import Layout from "../layouts/Layout.astro";
import LangColorBar from "../components/LangColorBar.astro";
import {
  getMultipleRepos,
  type Language,
} from "../utils/github";
import { normalizeCase } from "../utils/misc";
import { SITE_CONFIG } from "../config";

type Project = {
  name: string;
  description: string;
  url: string;
  languages: Language[];
};

const fetchProjects = async () => {
  try {
    // Fetch all repos in a single GraphQL query
    const reposMap = await getMultipleRepos(
      SITE_CONFIG.github.username,
      SITE_CONFIG.projects,
    );

    // Transform to project array, maintaining order
    const projects = SITE_CONFIG.projects
      .map((projectName) => {
        const repoData = reposMap.get(projectName);
        if (!repoData) return null;

        const { info: data, languages } = repoData;
        const shouldNormalize = data.name && !data.name.includes(".com");
        const name = shouldNormalize ? normalizeCase(data.name) : data.name;

        return {
          name: name,
          description: data.description,
          url: data.html_url,
          languages,
        };
      })
      .filter((p): p is Project => p !== null);

    return projects;
  } catch (error) {
    console.error("Error fetching projects:", error);
    return [];
  }
};

const projects: Project[] = await fetchProjects();
---

<Layout title="Projects">
  <main class="mt-8 px-4 max-w-65ch mx-auto">
  {
    projects.length > 0 ? (
      projects.map((project) => (
        <div class="flex flex-col mb-12">
          <a
            id="project-title"
            class="hover:underline"
            target="_blank"
            rel="noopener"
            href={project.url}
          >
            {project.name}
          </a>
          <div class="md:w-96 mt-1 mb-2">
            <LangColorBar
              languages={project.languages}
              projectUrl={project.url}
            />
          </div>
          <p>{project.description}</p>
        </div>
      ))
    ) : (
      <p>No projects available or failed to load.</p>
    )
  }
  </main>
</Layout>

<style>
  #project-title {
    font-family: var(--font-atkinson);
    font-size: 22px;
    text-decoration: none;
    line-height: 1.3;
    color: var(--color-text);
  }

  #project-title:visited {
    color: var(--color-text);
  }

  #project-title:hover,
  #project-title:focus-visible {
    color: #424949;
  }

  :global(html.dark) #project-title {
    color: #d1d5db;
  }

  :global(html.dark) #project-title:visited {
    color: #d1d5db;
  }

  :global(html.dark) #project-title:hover,
  :global(html.dark) #project-title:focus-visible {
    color: #ffffff;
  }
  
  p {
    font-family: var(--font-atkinson);
    font-size: clamp(1rem, 0.9rem + 0.5vw, 1.125rem);
    line-height: 1.6;
    text-align: justify;
    hyphens: auto;
    text-wrap: pretty;
    max-width: 65ch;
    margin-block: 1em;
  }

  p a {
    color: inherit;
    text-decoration: underline;
  }

  p a:hover,
  p a:focus-visible {
    color: #424949;
  }

  :global(html.dark) p a {
    color: #d1d5db;
  }

  :global(html.dark) p a:hover,
  :global(html.dark) p a:focus-visible {
    color: #a855f7;
  }

  @media (max-width: 600px) {
    p {
      text-align: left;
    }
  }
</style>
