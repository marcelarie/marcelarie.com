---
import Layout from "../layouts/Layout.astro";
import LangColorBar from "../components/LangColorBar.astro";
import {
  getMultipleRepos,
  type Language,
} from "../utils/github";
import { normalizeCase } from "../utils/misc";
import { SITE_CONFIG } from "../config";

type Project = {
  name: string;
  description: string;
  url: string;
  languages: Language[];
};

const fetchProjects = async () => {
  try {
    // Fetch all repos in a single GraphQL query
    const reposMap = await getMultipleRepos(
      SITE_CONFIG.github.username,
      SITE_CONFIG.projects,
    );

    // Transform to project array, maintaining order
    const projects = SITE_CONFIG.projects
      .map((projectName) => {
        const repoData = reposMap.get(projectName);
        if (!repoData) return null;

        const { info: data, languages } = repoData;
        const shouldNormalize = data.name && !data.name.includes(".com");
        const name = shouldNormalize ? normalizeCase(data.name) : data.name;

        return {
          name: name,
          description: data.description,
          url: data.html_url,
          languages,
        };
      })
      .filter((p): p is Project => p !== null);

    return projects;
  } catch (error) {
    console.error("Error fetching projects:", error);
    return [];
  }
};

const projects: Project[] = await fetchProjects();
---

<Layout title="Projects">
  {
    projects.length > 0 ? (
      projects.map((project) => (
        <div class="flex flex-col mb-8">
          <a
            id="project-title"
            class="hover:underline hover:text-blue-500"
            target="_blank"
            rel="noopener"
            href={project.url}
          >
            {project.name}
          </a>
          <div class="md:w-96 mt-1 mb-2">
            <LangColorBar
              languages={project.languages}
              projectUrl={project.url}
            />
          </div>
          <p>{project.description}</p>
        </div>
      ))
    ) : (
      <p>No projects available or failed to load.</p>
    )
  }
</Layout>

<style>
  #project-title {
    font-family: var(--font-mono);
    font-size: 20px;
    text-decoration: none;
  }
</style>
